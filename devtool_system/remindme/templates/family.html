{% extends 'base.html' %}

{% block title %}Family{% endblock %}

{% block content %}
<div class="m-3 dark:bg-black2 sm:px-6 sm:py-4 md:px-12 md:py-8 my-12 container mx-auto shadow-lg rounded-lg border dark:border-gray2">
  <div class="container mx-auto p-4 flex flex-col">
    <!-- Header -->
    <div class="flex justify-between items-center mb-4">
      <h1 id="monthYear" class="text-2xl font-bold dark:text-brown-50">Families ({{ user_families|length }})</h1>
      <div class="flex place-items-center gap-x-4 font-bold">
        <button id="openCreateModal" class="bg-brown-700 hover:bg-brown-800 active:bg-brown-900 px-5 py-2 rounded-lg text-white">Create</button>
        <button id="openJoinModal" class="text-brown-700 px-5 py-2 rounded-lg bg-gray-50 hover:bg-gray-100 active:bg-gray-200">Join</button>
      </div>
    </div>

    <!-- Grid Layout for Family Cards -->
    <div id="family_layout" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-4 gap-y-12">
      <!-- Loop through the user_families from the context -->
      {% for family in user_families %}
        <div class="flex flex-col p-4 bg-brown-50 border-brown-200 dark:bg-brown-950 rounded-lg shadow-md border dark:border-brown-900/60">
          <div class="relative">
            <div class="flex justify-between items-center mb-2">
              <h2 class="text-lg font-bold dark:text-brown-50">{{ family.name }}</h2>
              <div class="absolute right-0">
                <button onclick="copyToken('token{{ family.id }}')" class="text-sm text-white bg-blue-600 hover:bg-blue-700 active:bg-blue-800 px-3 py-2 rounded-lg font-bold">
                  Copy Token
                </button>
              </div>
            </div>
            <p class="mb-4 text-sm dark:text-brown-100">Token: <code id="token{{ family.id }}" class="font-mono p-1 rounded-lg bg-brown-200 dark:bg-brown-900 font-bold">{{ family.token }}</code></p>
          </div>

          <div class="relative overflow-x-auto shadow-sm sm:rounded-lg border border-brown-200 dark:border-brown-900">
            <table class="w-full text-sm font-light text-left rtl:text-right">
              <thead class="font-bold bg-brown-400 text-white">
                <tr>
                  <th class="px-4 py-2 text-center">#</th>
                  <th class="px-4 py-2">Member Name</th>
                  <th class="px-4 py-2 text-center">Birth Date</th>
                </tr>
              </thead>
              <tbody id="generateFamily_{{family.id}}">
                <!-- Generate by JavaScript -->
              </tbody>
            </table>
          </div>

          <!-- Action Buttons for Edit and Delete -->
          <div class="self-end mt-auto ">
            <div class="mt-4 flex space-x-3">
              <button class="bg-yellow-600 hover:bg-yellow-700 active:bg-yellow-800 text-white px-4 py-2 rounded-lg font-bold" data-family-id="{{ family.id }}" onclick="openEditModal('{{ family.id }}', '{{ family.name }}', '{{ family.users.all|safe }}')">
                Edit
              </button>
              <button class="bg-red-500 hover:bg-red-700 active:bg-red-900 text-white px-4 py-2 rounded-lg font-bold" onclick="confirmDelete('{{ family.id }}', '{{ family.name }}', '{{ csrf_token }}')">
                Delete
              </button>
            </div>
          </div>

        </div>

      {% empty %}
        <p class="text-center text-gray-500">You are not part of any families yet.</p>
      {% endfor %}
    </div>
  </div>
</div>

<!-- Create Family Modal -->
<div id="familyModal" class="fixed inset-0 flex items-center justify-center bg-gray-800 bg-opacity-50 hidden z-10">
  <div id="familyModalContent" class="transition-all -translate-y-full opacity-0 duration-500 bg-white rounded-lg shadow-lg p-6 w-96">
      <h2 class="text-lg text-brown-800 font-bold mb-4">Create Family</h2>
      <form id="eventForm" class="text-black" onsubmit="event.preventDefault(); createFamily(); this.reset();">
          {% csrf_token %}
          <div class="mb-4">
              <label for="familyName" class="block text-gray-700">Family Name:</label>
              <input type="text" id="familyName" name="familyName" required class="mt-1 block w-full border border-brown-700 rounded-md p-2 focus:outline-none focus:ring focus:ring-brown-500">
          </div>
          <div class="flex justify-end">
              <button type="button" id="closeModal" class="bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded mr-2">Cancel</button>
              <button type="submit" class="bg-brown-600 text-white font-bold py-2 px-4 rounded">Create</button>
          </div>
      </form>
  </div>
</div>

<!-- Join Family Modal -->
<div id="joinModal" class="fixed inset-0 flex items-center justify-center bg-gray-800 bg-opacity-50 hidden z-10">
  <div id="joinModalContent" class="transition-all -translate-y-full opacity-0 duration-500 bg-white rounded-lg shadow-lg p-6 w-96">
      <h2 class="text-lg text-brown-800 font-bold mb-4">Join Family</h2>
      <form id="joinForm" class="text-black" onsubmit="event.preventDefault(); joinFamily(); this.reset();">
          <div class="mb-4">
              <label for="familyToken" class="block text-gray-700">Family Token:</label>
              <input type="text" id="familyToken" class="mt-1 block w-full border border-brown-700 rounded-md p-2 focus:outline-none focus:ring focus:ring-brown-500" placeholder="Enter Family Token" required>
          </div>
          <div class="flex justify-end">
              <button id="closeJoinModal" type="button" class="bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded mr-2">Cancel</button>
              <button type="submit" class="bg-brown-600 text-white font-bold py-2 px-4 rounded">Join</button>
          </div>
      </form>
    </div>
</div>

<!-- Edit Family Modal -->
<div id="editModal" class="fixed inset-0 flex items-center justify-center bg-gray-800 bg-opacity-50 hidden z-10">
  <div id="editModalContent" class="transition-all -translate-y-full opacity-0 duration-500 bg-white rounded-lg shadow-lg p-6 w-full max-w-3xl">
    <h2 class="text-lg text-brown-800 font-bold mb-4">Edit Family</h2>
    <form id="editFamilyForm" class="flex flex-col gap-4 text-black" onsubmit="event.preventDefault(); saveFamily();">
      {% csrf_token %}
      <div>
        <label for="editFamilyName" class="block text-gray-700">Family Name</label>
        <input type="text" id="editFamilyName" name="editFamilyName" required class="mt-1 block w-full border border-brown-700 rounded-md p-2 focus:outline-none focus:ring focus:ring-brown-500">
      </div>
      <div class="relative overflow-x-auto shadow-sm sm:rounded-lg border border-brown-200 dark:border-brown-900">
        <table class="w-full text-sm font-light text-left rtl:text-right">
          <thead class="font-bold bg-brown-400 text-white">
            <tr>
              <th class="px-4 py-2">#</th>
              <th class="px-4 py-2">Name</th>
              <th class="px-4 py-2">Action</th>
            </tr>
          </thead>
          <tbody id="editMembersTable">
            <!-- Dynamic member rows will be injected here -->
          </tbody>
        </table>
      </div>
      
      <!-- Action Buttons for Cancel and Save -->
      <div class="self-end mt-auto">
        <div class="mt-4 flex space-x-3">
          <button type="button" onclick="closeEditModal()" id="closeModal" class="text-white bg-gray-500 px-4 py-2 rounded hover:bg-gray-600 active:bg-gray-800">Cancel</button>
          <button type="submit" class="bg-brown-600 hover:bg-brown-700 active:bg-brown-800 text-white px-4 py-2 rounded">Save</button>
        </div>
      </div>

    </form>
  </div>
</div>

{% endblock %}

{% block script %}
<script>

  // Open modal Create Family
  document.getElementById('openCreateModal').addEventListener('click', function() {
      document.getElementById('familyModal').classList.toggle('hidden');
      setTimeout(()=>{
        document.getElementById('familyModalContent').classList.toggle("opacity-0")
        document.getElementById('familyModalContent').classList.toggle("-translate-y-full")
      }, 200)
  });

  // Close modal Create Family
  document.getElementById('closeModal').addEventListener('click', function() {
    document.getElementById('familyModalContent').classList.toggle("opacity-0")
    document.getElementById('familyModalContent').classList.toggle("-translate-y-full")
    setTimeout(()=>document.getElementById('familyModal').classList.toggle('hidden'), 300)
  });

  // Open modal Join Family
  document.getElementById('openJoinModal').addEventListener('click', function() {
    document.getElementById('joinModal').classList.toggle('hidden');
    setTimeout(()=>{
      document.getElementById('joinModalContent').classList.toggle("opacity-0")
      document.getElementById('joinModalContent').classList.toggle("-translate-y-full")
    }, 200)
  });

  // Close modal Join Family
  document.getElementById('closeJoinModal').addEventListener('click', function() {
    document.getElementById('joinModalContent').classList.toggle("opacity-0")
    document.getElementById('joinModalContent').classList.toggle("-translate-y-full")
    setTimeout(()=>document.getElementById('joinModal').classList.toggle('hidden'), 300)
  });

  function openEditModal(familyId, familyName) {
    const editModal = document.getElementById('editModal')
    const editModalContent = document.getElementById('editModalContent')
    // console.log('Family ID:', familyId);
    // console.log('Family Name:', familyName);
    // console.log('Members JSON:', membersJson);
    // const members = JSON.parse(membersJson); // แปลง JSON string เป็น JavaScript object
    
    editModal.classList.toggle('hidden'); // Show the modal
    setTimeout(()=>{
      editModalContent.classList.toggle("opacity-0")
      editModalContent.classList.toggle("-translate-y-full")
    }, 200)
    const familyNameInput = document.getElementById('editFamilyName');
    familyNameInput.value = familyName; // Set the family name

    const membersTable = document.getElementById('editMembersTable');
    membersTable.innerHTML = ''; // Clear existing rows

    // สร้างแถวสำหรับสมาชิกแต่ละคนในตาราง

    fetch(`{{ base_url }}/api/family/${familyId}/`, {
      method: 'GET'
    })
      .then((response) => {
        if (!response.ok) {
          throw new Error('No events found')
        }
        return response.json()
      })
      .then((data) => {
        for(let i=0;i<data.display_users.length;i++){
          const memberRow = document.createElement('tr');
          memberRow.classList.add("bg-white", "border-b", "border-brown-300")
          memberRow.innerHTML = 
          `
            <td class="px-4 py-2 dark:text-brown-950">${i + 1}</td>
            <td class="px-4 py-2 dark:text-brown-950">${data.display_users[i].first_name} ${data.display_users[i].last_name}</td>
          `
          if ({{ user.id }} == data.display_users[i].id){
            memberRow.innerHTML +=
            `
            <td class="px-4 py-2 dark:text-brown-950">
                <button disabled type="button" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-lg disabled:opacity-50">Kick</button>
            </td>
            `
          }else{
            memberRow.innerHTML +=
            `
            <td class="px-4 py-2 dark:text-brown-950">
                <button type="button" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-lg disabled:opacity-50" onclick="removeMember(${data.display_users[i].id}, ${familyId})">Kick</button>
            </td>
            `
          }
          membersTable.appendChild(memberRow);
        }
      })
      .catch((error)=>{
        console.log(error)
      })
    /*
    members.forEach((user, index) => {
        const memberRow = document.createElement('tr');
        memberRow.innerHTML = `
            <td class="px-4 py-2">${index + 1}</td>
            <td class="px-4 py-2">${user.fields.first_name} ${user.fields.last_name}</td>
            <td class="px-4 py-2">
                <button type="button" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-lg" onclick="removeMember('${user.pk}', '${familyId}')">Delete</button>
            </td>
        `;
        membersTable.appendChild(memberRow);
    });
    */
  } 

  // Close the Edit Modal
  function closeEditModal() {
    const editModal = document.getElementById('editModal')
    const editModalContent = document.getElementById('editModalContent')

    editModalContent.classList.toggle("opacity-0")
    editModalContent.classList.toggle("-translate-y-full")

    setTimeout(()=>editModal.classList.toggle('hidden'), 300)
  }

  function getFamily(){
    const family_layout = document.getElementById("family_layout")
    family_layout.innerHTML = ``
    fetch(`{{ base_url }}{% url 'family_list' %}`, {
      method: 'GET'
    })
      .then((response) => {
        if (!response.ok) {
          throw new Error('No events found')
        }
        return response.json()
      })
      .then((data) => {
        let i=0
        for(;i<data.length;i++){
          // Generate Family table
          let div_family = document.createElement("div")
          div_family.classList.add("flex", "flex-col", "p-4", "bg-brown-50", "border-brown-200", "dark:bg-brown-950", "rounded-lg", "shadow-md", "border", "dark:border-brown-900/60")
          div_family.innerHTML = 
          `
            <div class="relative">
              <div class="flex justify-between items-center mb-2">
                <h2 class="text-lg font-bold dark:text-brown-50">${data[i].name}</h2>
                <div class="absolute right-0">
                  <button onclick="copyToken('token${data[i].id}')" class="text-sm text-white bg-blue-600 hover:bg-blue-700 active:bg-blue-800 px-3 py-2 rounded-lg font-bold">
                    Copy Token
                  </button>
                </div>
              </div>
              <p class="mb-4 text-sm dark:text-brown-100">Token: <code id="token${data[i].id}" class="font-mono p-1 rounded-lg bg-brown-200 dark:bg-brown-900 font-bold">${data[i].token}</code></p>
            </div>

            <div class="relative overflow-x-auto shadow-sm sm:rounded-lg border border-brown-200 dark:border-brown-900">
              <table class="w-full text-sm font-light text-left rtl:text-right">
                <thead class="font-bold bg-brown-400 text-white">
                  <tr>
                    <th class="px-4 py-2 text-center">#</th>
                    <th class="px-4 py-2">Member Name</th>
                    <th class="px-4 py-2 text-center">Birth Date</th>
                  </tr>
                </thead>
                <tbody id="generateFamily_${data[i].id}">
                  <!-- Generate by JavaScript -->
                </tbody>
              </table>
            </div>

            <!-- Action Buttons for Edit and Delete -->
            <div class="self-end mt-auto ">
              <div class="mt-4 flex space-x-3">
                <button class="bg-yellow-600 hover:bg-yellow-700 active:bg-yellow-800 text-white px-4 py-2 rounded-lg font-bold" data-family-id="${data[i].id}" onclick="openEditModal('${data[i].id}', '${data[i].name}')">
                  Edit
                </button>
                <button class="bg-red-500 hover:bg-red-700 active:bg-red-900 text-white px-4 py-2 rounded-lg font-bold" onclick="confirmDelete('${data[i].id}', '${data[i].name}', '{{ csrf_token }}')">
                  Delete
                </button>
              </div>
            </div>
          `
          family_layout.append(div_family)

          // Generate Member
          let generateFamily = document.getElementById(`generateFamily_${data[i].id}`)
          generateFamily.innerHTML=``
          
          if (data[i].display_users.length == 0){
            generateFamily.innerHTML += 
            `<tr>
                <td class="px-4 py-2" colspan="3">No members found</td>
            </tr>`
          }else{
            let j=0
            for(;j<data[i].display_users.length && j<4;j++){
              generateFamily.innerHTML += 
              `
              <tr class="bg-white border-b border-brown-300">
                  <td class="px-4 py-2 dark:text-brown-950 text-center">${j+1}</td>
                  <td class="px-4 py-2 dark:text-brown-950">${data[i].display_users[j].first_name} ${data[i].display_users[j].last_name}</td>
                  <td class="px-4 py-2 dark:text-brown-950 text-center">${data[i].display_users[j].birth_date}</td>
              </tr>
              `
            }
            if (j>=4){
              generateFamily.innerHTML += 
              `
              <tr>
                  <td class="px-4 py-2" colspan="3">... and ${j-3} more</td>
              </tr>
              `
            }
          }
        }
      })
      .catch((error) => {
        console.log(error)
      })
  }

  function createFamily() {
    const familyName = document.getElementById('familyName').value;
    
    fetch(`{{ base_url }}{% url 'family_list' %}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}', // ส่ง CSRF token
        },
        body: JSON.stringify({ name: familyName })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok.');
        }
        return // แปลงเป็น JSON
    })
    .then(data => {
        // แสดงข้อความแจ้งเตือนการสร้างสำเร็จพร้อมชื่อของครอบครัว
        show_alert(`Family "${familyName}" created successfully!`);
        document.getElementById('familyModal').classList.toggle('hidden'); // ปิด modal
        // สามารถรีเฟรชหน้าหรือเรียกข้อมูลใหม่ที่นี่
        getFamily()
    })
    .catch(error => {
        console.error('Error:', error);
        show_error('Failed to create family.');
    });
}

function joinFamily() {
    const familyToken = document.getElementById('familyToken').value;

    fetch(`{{ base_url }}/api/join/${familyToken}/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}', // Send CSRF token
      }
    })
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok.');
      }
      return // Convert to JSON
    })
    .then(data => {
      // Show success alert for joining family
      show_alert(`Join family successful`);
      document.getElementById('joinModal').classList.toggle('hidden'); // Close modal
      getFamily()
    })
    .catch(error => {
      console.error('Error:', error);
      show_error('Failed to join family. Please check the token and try again.');
    });
  }

  function removeMember(userId, familyId) {
  if (confirm('Are you sure you want to remove this member?')) {
    fetch(`{{ base_url }}/api/member/${familyId}/${userId}/`, {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}',
      }
    })
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok.');
        }
      })
      .then(data => {
        show_alert('Member removed successfully!');
        getFamily()
        closeEditModal()
      })
      .catch(error => {
        console.error('Error:', error);
        show_error('Failed to remove member.');
      });
    }
  }

  function copyToken(tokenId) {
  const tokenElement = document.getElementById(tokenId);
  if (tokenElement) {
    navigator.clipboard.writeText(tokenElement.textContent).then(function() {
      show_alert('Token copied: ' + tokenElement.textContent);
    }).catch(function(err) {
      console.error('Error copying token: ', err);
      show_error('Failed to copy token.');
    });
  } else {
    show_error('Token element not found');
  }
}

function confirmDelete(familyId, familyName, csrf_token) {
    if (confirm('Are you sure you want to delete this family?')) {
      // ส่งคำขอลบไปยังเซิร์ฟเวอร์
      fetch(`{{ base_url }}/api/family/${familyId}/`, {
        method: "DELETE", // ใช้ DELETE method
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": csrf_token, // ส่ง CSRF token
        },
      })
      .then((response) => {
        if (response.ok) {
          return // แปลงเป็น JSON
        }
        throw new Error('Network response was not ok.');
      })
      .then((data) => {
        // แสดงข้อความแจ้งเตือนการลบสำเร็จพร้อมชื่อของครอบครัว
        show_alert('Deletion successful for family: ' + familyName);
        getFamily() // รีโหลดข้อมูล Family
      })
      .catch((error) => {
        console.error("Error:", error);
        show_error('Failed to delete family.'); // แสดงข้อความหากเกิดข้อผิดพลาด
      });
    }
  }

  // Load function
  getFamily()
</script>
{% endblock %}
