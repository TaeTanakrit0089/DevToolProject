{% extends 'base.html' %}

{% block title %}Family{% endblock %}

{% block content %}
<div class="m-3 dark:bg-black2 sm:px-6 sm:py-4 md:px-12 md:py-8 my-12 container mx-auto shadow-lg rounded-lg border dark:border-gray2">
  <div class="container mx-auto p-4 flex flex-col">
    <!-- Header -->
    <div class="flex justify-between items-center mb-4">
      <h1 id="monthYear" class="text-2xl font-bold dark:text-brown-50">Families ({{ user_families|length }})</h1>
      <div class="flex place-items-center gap-x-4 font-bold">
        <button id="openCreateModal" class="bg-brown-700 hover:bg-brown-800 active:bg-brown-900 px-5 py-2 rounded-lg text-white">Create</button>
        <button id="openJoinModal" class="text-brown-700 px-5 py-2 rounded-lg bg-gray-50 hover:bg-gray-100 active:bg-gray-200">Join</button>
      </div>
    </div>

    <!-- Grid Layout for Family Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <!-- Loop through the user_families from the context -->
      {% for family in user_families %}
      <div class="p-4 bg-white dark:bg-gray-800 rounded-lg shadow-md border dark:border-gray2">
        <div class="flex justify-between items-center mb-2">
          <h2 class="text-lg font-bold dark:text-brown-50">{{ family.name }}</h2>
          <button onclick="copyToken('token{{ family.id }}')" class="text-sm text-white bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded-lg">
            Copy Token
          </button>
        </div>
        <p class="mb-4 text-sm text-gray-600 dark:text-gray-400">Token: <span id="token{{ family.id }}" class="font-mono">{{ family.token }}</span></p>
        
        <!-- Action Buttons for Edit and Delete -->
        <div class="flex space-x-4 mb-4">
          <button class="bg-yellow-600 hover:bg-yellow-700 active:bg-yellow-800 text-white px-4 py-2 rounded-lg">
            Edit
          </button>
          <button class="bg-red-600 hover:bg-red-700 active:bg-red-800 text-white px-4 py-2 rounded-lg" onclick="confirmDelete('{{ family.id }}', '{{ family.name }}', '{{ csrf_token }}')">
            Delete
          </button>
        </div>      

        <table class="table-auto w-full text-left text-sm mb-4">
          <thead>
            <tr class="bg-gray-200 dark:bg-gray-700">
              <th class="px-4 py-2">#</th>
              <th class="px-4 py-2">Name</th>
              <th class="px-4 py-2">Birth Date</th>
            </tr>
          </thead>
          <tbody>
            {% if family.users.count == 0 %}
            <tr>
                <td class="px-4 py-2" colspan="3">No members found</td>
            </tr>
            {% else %}
                {% for user in family.users.all %}
                    {% if forloop.counter <= 4 %}
                    <tr>
                        <td class="px-4 py-2">{{ forloop.counter }}</td>
                        <td class="px-4 py-2">{{ user.first_name }} {{ user.last_name }}</td>
                        <td class="px-4 py-2">{{ user.birth_date|date:"d-m-Y" }}</td>
                    </tr>
                    {% endif %}
                {% endfor %}
                {% if family.users.count > 4 %}
                <tr>
                    <td class="px-4 py-2" colspan="3">... and {{ family.users.count|add:-4 }} more</td>
                </tr>
                {% endif %}
            {% endif %}
          </tbody>
        </table>

      </div>
      {% empty %}
      <p class="text-center text-gray-500">You are not part of any families yet.</p>
      {% endfor %}
    </div>
  </div>
</div>

<!-- Create Family Modal -->
<div id="modal" class="fixed inset-0 flex items-center justify-center bg-gray-800 bg-opacity-50 hidden">
  <div class="bg-white rounded-lg shadow-lg p-6 w-96">
      <h2 class="text-lg text-brown-800 font-bold mb-4">Create Family</h2>
      <form id="eventForm" class="text-black" onsubmit="event.preventDefault(); createFamily(); this.reset();">
          {% csrf_token %}
          <div class="mb-4">
              <label for="familyName" class="block text-gray-700">Family Name:</label>
              <input type="text" id="familyName" name="familyName" required class="mt-1 block w-full border border-brown-700 rounded-md p-2 focus:outline-none focus:ring focus:ring-brown-500">
          </div>
          <div class="flex justify-end">
              <button type="button" id="closeModal" class="bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded mr-2">Cancel</button>
              <button type="submit" class="bg-brown-600 text-white font-bold py-2 px-4 rounded">Create</button>
          </div>
      </form>
  </div>
</div>

<!-- Join Family Modal -->
<div id="joinModal" class="fixed inset-0 flex items-center justify-center bg-gray-800 bg-opacity-50 hidden">
  <div class="bg-white rounded-lg shadow-lg p-6 w-96">
      <h2 class="text-lg text-brown-800 font-bold mb-4">Join Family</h2>
      <form id="joinForm" class="text-black" onsubmit="event.preventDefault(); joinFamily(); this.reset();">
          <div class="mb-4">
              <label for="familyToken" class="block text-gray-700">Family Token:</label>
              <input type="text" id="familyToken" class="mt-1 block w-full border border-brown-700 rounded-md p-2 focus:outline-none focus:ring focus:ring-brown-500" placeholder="Enter Family Token" required>
          </div>
          <div class="flex justify-end">
              <button id="closeJoinModal" type="button" class="bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded mr-2">Cancel</button>
              <button type="submit" class="bg-brown-600 text-white font-bold py-2 px-4 rounded">Join</button>
          </div>
      </form>
  </div>
</div>

{% endblock %}

{% block script %}
<script>

  // Open modal Create Family
  document.getElementById('openCreateModal').addEventListener('click', function() {
        document.getElementById('modal').classList.remove('hidden');
    });

  // Close modal Create Family
  document.getElementById('closeModal').addEventListener('click', function() {
      document.getElementById('modal').classList.add('hidden');
  });

  // Open modal Join Family
  document.getElementById('openJoinModal').addEventListener('click', function() {
    document.getElementById('joinModal').classList.remove('hidden');
  });

  // Close modal Join Family
  document.getElementById('closeJoinModal').addEventListener('click', function() {
    document.getElementById('joinModal').classList.add('hidden');
  });

  function createFamily() {
    const familyName = document.getElementById('familyName').value;
    
    const url = `/family/create/${familyName}/`;
    
    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}', // ส่ง CSRF token
        },
        body: JSON.stringify({ name: familyName })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok.');
        }
        return response.json(); // แปลงเป็น JSON
    })
    .then(data => {
        // แสดงข้อความแจ้งเตือนการสร้างสำเร็จพร้อมชื่อของครอบครัว
        show_alert(`Family "${data.name}" created successfully!`);
        document.getElementById('modal').classList.add('hidden'); // ปิด modal
        // สามารถรีเฟรชหน้าหรือเรียกข้อมูลใหม่ที่นี่
    })
    .catch(error => {
        console.error('Error:', error);
        show_alert('Failed to create family.');
    });
}

function joinFamily() {
    const familyToken = document.getElementById('familyToken').value;
    
    const url = `/family/join/${familyToken}/`;

    fetch(url, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}', // Send CSRF token
      }
    })
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok.');
      }
      return response.json(); // Convert to JSON
    })
    .then(data => {
      // Show success alert for joining family
      show_alert(data.message);
      document.getElementById('joinModal').classList.add('hidden'); // Close modal
      
    })
    .catch(error => {
      console.error('Error:', error);
      show_alert('Failed to join family. Please check the token and try again.');
    });
  }

  function copyToken(tokenId) {
  const tokenElement = document.getElementById(tokenId);
  if (tokenElement) {
    navigator.clipboard.writeText(tokenElement.textContent).then(function() {
      show_alert('Token copied: ' + tokenElement.textContent);
    }).catch(function(err) {
      console.error('Error copying token: ', err);
      show_alert('Failed to copy token.');
    });
  } else {
    show_alert('Token element not found');
  }
}

function confirmDelete(familyId, familyName, csrf_token) {
    if (confirm('Are you sure you want to delete this family?')) {
      // ส่งคำขอลบไปยังเซิร์ฟเวอร์
      fetch(`/family/delete/${familyId}/`, {
        method: "DELETE", // ใช้ DELETE method
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": csrf_token, // ส่ง CSRF token
        },
      })
      .then((response) => {
        if (response.ok) {
          return response.json(); // แปลงเป็น JSON
        }
        throw new Error('Network response was not ok.');
      })
      .then((data) => {
        // แสดงข้อความแจ้งเตือนการลบสำเร็จพร้อมชื่อของครอบครัว
        show_alert('Deletion successful for family: ' + familyName);
        window.location.reload(); // รีเฟรชหน้าหลังจากลบ
      })
      .catch((error) => {
        console.error("Error:", error);
        show_alert('Failed to delete family.'); // แสดงข้อความหากเกิดข้อผิดพลาด
      });
    } else {
      show_alert('Deletion cancelled.');
    }
  }
</script>
{% endblock %}
