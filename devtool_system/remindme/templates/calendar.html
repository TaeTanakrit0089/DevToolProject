{% extends 'base.html' %}

{% block title %}
  Dynamic Calendar
{% endblock %}

{% block content %}
  <div class="m-3 dark:bg-black2 sm:px-6 sm:py-4 md:px-12 md:py-8 my-12 container mx-auto shadow-lg rounded-lg border dark:border-gray2">
    <div class="container mx-auto p-4 flex flex-col">
      <!-- Header -->
      <div class="flex justify-between items-center mb-4">
        <h1 id="monthYear" class="text-2xl font-bold dark:text-brown-50">January 2022</h1>
        <div class="flex place-items-center gap-x-4 font-bold">
          <button id="todayBtn" class="bg-brown-700 hover:bg-brown-800 active:bg-brown-900 px-3 py-2 rounded-lg text-white">Today</button>
        </div>
      </div>

      <!-- Calendar -->
      <div class="grid grid-cols-7 gap-2 text-center text-sm font-medium text-brown-800 dark:text-brown-100">
        <!-- วันในสัปดาห์ -->
        <div>Sun</div>
        <div>Mon</div>
        <div>Tue</div>
        <div>Wed</div>
        <div>Thu</div>
        <div>Fri</div>
        <div>Sat</div>
      </div>

      <!-- กล่องวันที่ของปฏิทิน -->
      <div id="calendar-days" class="grid grid-cols-7 gap-2 mt-2 text-lg">
        <!-- วันที่ต่างๆ จะถูกสร้างด้วย JavaScript -->
      </div>

      <div class="flex place-items-center gap-x-4 self-end mt-4">
        <button id="prevMonthBtn" class="bg-brown-700 hover:bg-brown-800 active:bg-brown-900 rounded-full size-10 text-white text-xl">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6 m-auto">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" />
        </svg>
        </button>
        <button id="nextMonthBtn" class="bg-brown-700 hover:bg-brown-800 active:bg-brown-900 rounded-full size-10 text-white text-xl">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6 m-auto">
            <path stroke-linecap="round" stroke-linejoin="round" d="m8.25 4.5 7.5 7.5-7.5 7.5" />
          </svg>          
        </button>
      </div>
    </div>
  </div>

  <div id="eventContainer" class="m-3 dark:bg-black2 px-12 py-8 my-12 container mx-auto p-4 shadow-lg rounded-lg mt-4 border dark:border-gray2">
    <!-- ตารางข้อมูลกิจกรรม -->
    <div id="eventDetails">
      <h2 class="text-xl font-bold mb-4 flex justify-between items-center">
        <div>
          Events for<p id="selectedDate"></p>
        </div>
        <button id="addEventModalBtn" class="hidden sm:block bg-brown-800 text-white px-4 py-2 rounded-lg">Add Event</button>
      </h2>

      <!-- ตารางแสดงข้อมูล Calendar -->
      <div class="relative overflow-x-auto shadow-md sm:rounded-lg">
        <table class="w-full font-light text-lg text-left rtl:text-right">
          <thead class="text-base font-bold bg-brown-400">
            <tr>
              <th class="px-4 py-2 border-0">Time</th>
              <th class="px-4 py-2 border-0">Event Name</th>
              <th class="px-4 py-2 border-0">Description</th>
            </tr>
          </thead>
          <tbody id="eventTableBody" class="divide-y divide-brown-800">
            <!-- Generate By JavaScript -->
          </tbody>
        </table>
      </div>

      <button id="addEventModalBtn2" class="block sm:hidden mt-2 bg-brown-800 text-white px-4 py-2 rounded">Add Event</button>
    </div>
  </div>

  <!-- Modal สำหรับเพิ่มกิจกรรม -->
  <div id="eventModal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex justify-center items-center z-10">
    <div class="w-full">
      <div id="eventModalContent" class="transition-all -translate-y-full opacity-0 duration-700 bg-white p-6 rounded-lg sm:mx-12 md:mx-48 lg:mx-56 xl:mx-96">
        <div class="text-xl font-bold mb-2 text-brown-700">
          Add Event for<p id="selectedModalDate"></p>
        </div>
        <form id="eventForm" class="text-black" onsubmit="event.preventDefault(); add_event(); this.reset();">
          {% csrf_token %}

          <input type="hidden" name="noti_date" id="notiDateInput" value="" />

          {{ form.non_field_errors }}
          <div class="mb-1">
            <label for="{{ form.name.id_for_label }}" class="text-sm font-medium">{{ form.name.label }}</label>
            {{ form.name }}
            {% if form.name.errors %}
              <div class="text-red-500 text-sm">{{ form.name.errors }}</div>
            {% endif %}
          </div>
          <div class="mb-1">
            <label for="{{ form.description.id_for_label }}" class="text-sm font-medium">{{ form.description.label }}</label>
            {{ form.description }}
            {% if form.description.errors %}
              <div class="text-red-500 text-sm">{{ form.description.errors }}</div>
            {% endif %}
          </div>

          <div class="flex flex-col sm:flex-row gap-x-3">
            <div class="mb-1">
              <label for="{{ form.noti_time.id_for_label }}" class="text-sm font-medium">{{ form.noti_time.label }}</label>
              <br />
              {{ form.noti_time }}
              {% if form.noti_time.errors %}
                <div class="text-red-500 text-sm">{{ form.noti_time.errors }}</div>
              {% endif %}
            </div>
            <div class="mb-1">
              <label for="{{ form.routine.id_for_label }}" class="text-sm font-medium">{{ form.routine.label }}</label>
              <br />
              {{ form.routine }}
              {% if form.routine.errors %}
                <div class="text-red-500 text-sm">{{ form.routine.errors }}</div>
              {% endif %}
            </div>
          </div>

          <div class="mb-1">
            <label for="{{ form.family.id_for_label }}" class="text-sm font-medium">{{ form.family.label }} (Optional)</label>
            <p class="text-xs font-bold">{{ form.family.help_text }}</p>
            {{ form.family }}
            {% if form.family.errors %}
              <div class="text-red-500 text-sm">{{ form.family.errors }}</div>
            {% endif %}
          </div>

          <div class="flex justify-end space-x-4">
            <button type="button" id="closeModal" class="text-white bg-gray-500 px-4 py-2 rounded hover:bg-gray-600 active:bg-gray-800">Cancel</button>
            <button type="submit" class="bg-brown-600 hover:bg-brown-700 active:bg-brown-800 text-white px-4 py-2 rounded">Save</button>
          </div>
        </form>
      </div>
    </div>
  </div>
{% endblock %}
{% block script %}
  <script>
    const monthYearElement = document.getElementById('monthYear')
    const calendarDaysElement = document.getElementById('calendar-days')
    const prevMonthBtn = document.getElementById('prevMonthBtn')
    const nextMonthBtn = document.getElementById('nextMonthBtn')
    const todayBtn = document.getElementById('todayBtn')
    const eventDetails = document.getElementById('eventDetails')
    const selectedDateElement = document.getElementById('selectedDate')
    const eventTableBody = document.getElementById('eventTableBody')
    const addEventModalBtn = document.getElementById('addEventModalBtn')
    const addEventModalBtn2 = document.getElementById('addEventModalBtn2')
    const notiDateInput = document.getElementById('notiDateInput')
    
    // Open modal to add event
    addEventModalBtn.addEventListener('click', () => {
      const selectedDate = selectedDateElement.innerText
      document.getElementById('selectedModalDate').innerText = selectedDate
      notiDateInput.value = selectedDate
    
      document.getElementById('eventModal').classList.toggle('hidden')
      setTimeout(() => {
        document.getElementById('eventModalContent').classList.toggle('-translate-y-full')
        document.getElementById('eventModalContent').classList.toggle('opacity-0')
      }, 100)
    })
    
    addEventModalBtn2.addEventListener('click', () => {
      const selectedDate = selectedDateElement.innerText
      document.getElementById('selectedModalDate').innerText = selectedDate
      notiDateInput.value = selectedDate
    
      document.getElementById('eventModal').classList.toggle('hidden')
      setTimeout(() => {
        document.getElementById('eventModalContent').classList.toggle('-translate-y-full')
        document.getElementById('eventModalContent').classList.toggle('opacity-0')
      }, 100)
    })
    
    // Close modal
    document.getElementById('closeModal').addEventListener('click', () => {
      document.getElementById('eventModalContent').classList.toggle('-translate-y-full')
      document.getElementById('eventModalContent').classList.toggle('opacity-0')
      setTimeout(() => document.getElementById('eventModal').classList.toggle('hidden'), 300) // Hide the modal
    })
    
    let currentDate = new Date()
    
    async function renderCalendar() {
      calendarDaysElement.innerHTML = ''
      const year = currentDate.getFullYear()
      const month = currentDate.getMonth()
      const response = await fetch(`{{ base_url }}/api/events/user/${year}/${month + 1}/count/`).then((response) => response.json())
      const monthYearString = currentDate.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long'
      })
      monthYearElement.innerText = monthYearString
      const firstDayOfMonth = new Date(year, month, 1).getDay()
      const lastDateOfMonth = new Date(year, month + 1, 0).getDate()
      const today = new Date()
      const lastDatePrevMonth = new Date(year, month, 0).getDate()
    
      // Fill previous month's days
      for (let i = 0; i < firstDayOfMonth; i++) {
        const prevMonthDate = lastDatePrevMonth - firstDayOfMonth + i + 1
        const dateDiv = document.createElement('div')
        dateDiv.classList.add('bg-brown-100', 'text-brown-400', 'p-2', 'rounded', 'shadow', 'text-center', 'cursor-not-allowed')
        dateDiv.innerText = prevMonthDate
        calendarDaysElement.appendChild(dateDiv)
      }
    
      const days_event = response.map((e) => {
        return e.noti_date__day
      })
      // Fill current month's days
      for (let date = 1; date <= lastDateOfMonth; date++) {
        const dateDiv = document.createElement('div')
        dateDiv.classList.add('bg-white', 'text-brown-950', 'p-2', 'rounded', 'shadow', 'text-center', 'cursor-pointer', 'relative')
        dateDiv.innerText = date
    
        if ((year <= today.getFullYear() && month <= today.getMonth() && date < today.getDate()) || (year <= today.getFullYear() && month < today.getMonth()) || year < today.getFullYear()) {
          dateDiv.classList.add('opacity-80')
        }
    
        // Highlight today's date and fetch events
        if (date === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
          dateDiv.classList.add('bg-brown-700', 'text-white')
          dateDiv.classList.remove('bg-white', 'text-brown-950')
          fetchAndDisplayEvents(today.toLocaleDateString('en-CA'))
        }
    
        // Add click event to fetch and display events for the selected date
        dateDiv.addEventListener('click', () => {
          const selectedDate = new Date(year, month, date).toLocaleDateString('en-CA')
          selectedDateElement.innerText = selectedDate
    
          if (addEventModalBtn.classList.contains('hidden')) {
            addEventModalBtn.classList.remove('hidden')
          }
          if (addEventModalBtn.classList.contains('sm:block')) {
            addEventModalBtn.classList.remove('sm:block')
          }
          if (addEventModalBtn2.classList.contains('sm:hidden')) {
            addEventModalBtn2.classList.remove('sm:hidden')
          }
          if (addEventModalBtn2.classList.contains('block')) {
            addEventModalBtn2.classList.remove('block')
          }
          if (!(year >= today.getFullYear() && month >= today.getMonth() && date >= today.getDate())) {
            addEventModalBtn.classList.add('hidden')
            addEventModalBtn2.classList.add('hidden')
          } else {
            addEventModalBtn.classList.remove('hidden')
            addEventModalBtn2.classList.remove('hidden')
    
            addEventModalBtn.classList.add('hidden', 'sm:block')
            addEventModalBtn2.classList.add('sm:hidden', 'block')
          }
    
          fetchAndDisplayEvents(selectedDate)
        })
    
        // Add notification light
        if (days_event.includes(date)) {
          let noti_light = document.createElement('div')
          let noti_light2 = document.createElement('div')
    
          if (year >= today.getFullYear() && month >= today.getMonth() && date > today.getDate()) {
            noti_light.classList.add('absolute', 'size-4', 'bg-sky-700', 'dark:bg-sky-500', '-top-1', '-right-1', 'rounded-full', 'animate-ping', 'z-10')
            noti_light2.classList.add('absolute', 'size-4', 'bg-sky-700', 'dark:bg-sky-500', '-top-1', '-right-1', 'rounded-full', 'z-10')
          } else if (year == today.getFullYear() && month == today.getMonth() && date == today.getDate()) {
            noti_light.classList.add('absolute', 'size-4', 'bg-red-700', 'dark:bg-red-500', '-top-1', '-right-1', 'rounded-full', 'animate-ping', 'z-10')
            noti_light2.classList.add('absolute', 'size-4', 'bg-red-700', 'dark:bg-red-500', '-top-1', '-right-1', 'rounded-full', 'z-10')
          } else {
            noti_light2.classList.add('absolute', 'size-4', 'bg-gray-500', '-top-1', '-right-1', 'rounded-full', 'z-10')
          }
    
          dateDiv.append(noti_light, noti_light2)
          days_event.shift()
        }
    
        calendarDaysElement.appendChild(dateDiv)
      }
    
      const remainingDays = 42 - firstDayOfMonth - lastDateOfMonth
      // Fill remaining days
      for (let i = 1; i <= remainingDays; i++) {
        const dateDiv = document.createElement('div')
        dateDiv.classList.add('bg-brown-100', 'text-brown-400', 'p-2', 'rounded', 'shadow', 'text-center', 'cursor-not-allowed')
        dateDiv.innerText = i
        calendarDaysElement.appendChild(dateDiv)
      }
    }
    
    function fetchAndDisplayEvents(selectedDate) {
      selectedDateElement.innerText = selectedDate
      const year = Number(selectedDate.substring(0, 4))
      const month = Number(selectedDate.substring(5, 7))
      const day = Number(selectedDate.substring(8, 10))
      fetch(`{{ base_url }}/api/events/user/${year}/${month}/${day}/`, {
        method: 'GET'
      })
        .then((response) => {
          if (!response.ok) {
            throw new Error('No events found')
          }
          return response.json()
        })
        .then((data) => {
          eventTableBody.innerHTML = '' // Clear previous event data
    
          if (data.length > 0) {
            // Populate table with new events
            data.forEach((event) => {
              const [year, month, day] = event.noti_date.split('-')
              const [hour, minute, second] = event.noti_time.split(':')
              const currentDateEvent = new Date(year, Number(month) - 1, day, hour, minute, second)
    
              const row = document.createElement('tr')
              row.classList.add('bg-white', 'border-b', 'dark:bg-brown-950', 'dark:border-b-brown-800')
              row.innerHTML = `
                                                                              <td class="px-4 py-2">${hour}:${minute}</td>
                                                                              <td class="px-4 py-2">${event.name}</td>
                                                                              <td class="px-4 py-2">${event.description}</td>
                                                                          `
              if (currentDate.getTime() > currentDateEvent.getTime()) row.classList.add('opacity-50')
              eventTableBody.appendChild(row)
            })
          } else {
            // If no events, display a message
            const noEventRow = document.createElement('tr')
            noEventRow.classList.add('bg-white', 'border-b', 'dark:bg-brown-950', 'dark:border-b-brown-800')
            noEventRow.innerHTML = `
                                                                          <td colspan="3" class="px-4 py-2 text-center">No events scheduled for this day</td>
                                                                      `
            eventTableBody.appendChild(noEventRow)
          }
    
          // Show the event details section and the container
          eventDetails.classList.remove('hidden')
          document.getElementById('eventContainer').classList.remove('hidden')
        })
        .catch((error) => {
          // Handle errors
          eventTableBody.innerHTML = '' // Clear previous event data
          const noEventRow = document.createElement('tr')
          noEventRow.innerHTML = `
                                                                      <td colspan="3" class="px-4 py-2 text-center">Error: ${error.message}</td>
                                                                  `
          eventTableBody.appendChild(noEventRow)
          eventDetails.classList.remove('hidden')
          document.getElementById('eventContainer').classList.remove('hidden')
        })
    }
    
    prevMonthBtn.addEventListener('click', () => {
      currentDate.setMonth(currentDate.getMonth() - 1)
      renderCalendar()
    })
    
    nextMonthBtn.addEventListener('click', () => {
      currentDate.setMonth(currentDate.getMonth() + 1)
      renderCalendar()
    })
    
    todayBtn.addEventListener('click', () => {
      currentDate = new Date() // Set current date
      renderCalendar() // Render the calendar for the current date
      fetchAndDisplayEvents(currentDate.toLocaleDateString('en-CA')) // Fetch events for today's date
    })
    
    renderCalendar()
  </script>

  <script>
    function add_event() {
      let data = {
        user: '{{ user.id }}',
        name: document.getElementById('{{form.name.id_for_label}}').value,
        noti_date: document.getElementById('notiDateInput').value,
        noti_time: document.getElementById('{{form.noti_time.id_for_label}}').value,
        description: document.getElementById('{{form.description.id_for_label}}').value,
        family: document.getElementById('{{form.family.id_for_label}}').value
      }
      fetch("{{ base_url }}{% url 'event_list' %}", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify(data)
      })
        .then((response) => {
          if (!response.ok) {
            throw new Error('Cannot add event to the past.')
          }
          show_alert('Add event successful.')
          document.getElementById('eventModal').classList.toggle('hidden')
          fetchAndDisplayEvents(document.getElementById('selectedDate').innerText)
        })
        .catch((error) => {
          show_error(error)
        })
    }
  </script>
{% endblock %}
